<template>
  <!-- 分析师对应内容 -->
  <div>
    <el-dialog
      @close="closeDialog"
      title="分析师战绩"
      :visible.sync="exploitsVisible"
      width="1200px"
    >
      <div class="table_wrap">
        <div class="add_wrap">
          <el-button
            size="small"
            v-if="!isEdit"
            type="primary"
            @click="showAdd(true)"
            >立即添加</el-button
          >
          <el-button
            size="small"
            v-if="multipleSelection.length"
            type="danger"
            @click="delItems"
            >批量删除</el-button
          >
        </div>

        <el-table
          :data="exploitsList"
          border
          style="width: 100%"
          @selection-change="handleSelectionChange"
        >
          <el-table-column type="selection" width="40"> </el-table-column>
          <el-table-column label="编号" width="50" prop="id" />
          <el-table-column label="时间" width="160" prop="gameDateTime" />
          <el-table-column label="赛事" width="150" prop="leagueName" />
          <el-table-column label="主队" width="150" prop="teamOne" />
          <el-table-column label="客队" width="150" prop="teamTwo" />
          <el-table-column label="推荐" width="150" prop="winnerTeam" />
          <el-table-column label="比分" width="80" prop="score" />
          <el-table-column label="成绩" width="80" prop="result" />
          <el-table-column label="操作">
            <template slot-scope="scope">
              <el-button size="mini" @click="handleEdit(scope.row)"
                >编辑</el-button
              >
              <el-button
                size="mini"
                type="danger"
                @click="handleDeleteSingle(scope.row)"
                >删除</el-button
              >
            </template>
          </el-table-column>
        </el-table>
        <div class="pagenation">
          <el-pagination
            background
            @current-change="pagenatiOnchange"
            layout="prev, pager, next"
            :page-size="exploitsListInfo.size"
            :current-page="exploitsListInfo.current"
            :total="exploitsListInfo.total"
          >
          </el-pagination>
        </div>
      </div>
    </el-dialog>

    <el-dialog title="提示" :visible.sync="pageDialogVisible" width="400px">
      <div class="add_wrap">
        <el-form ref="form" :model="form" label-width="80px">
          <el-form-item label="活动时间">
            <el-date-picker
              v-model="form.gameDateTime"
              type="datetime"
              placeholder="选择比赛时间"
              value-format="yyyy-MM-dd hh:mm:ss"
            >
            </el-date-picker>
          </el-form-item>
          <el-form-item label="赛事名称">
            <el-input v-model="form.leagueName"></el-input>
          </el-form-item>
          <el-form-item label="主队">
            <el-input v-model="form.teamOne"></el-input>
          </el-form-item>
          <el-form-item label="客队">
            <el-input v-model="form.teamTwo"></el-input>
          </el-form-item>
          <el-form-item label="推荐">
            <el-input v-model="form.winnerTeam"></el-input>
          </el-form-item>
          <el-form-item label="比分">
            <el-input v-model="form.score"></el-input>
          </el-form-item>
          <el-form-item label="成绩">
            <el-input v-model="form.result"></el-input>
          </el-form-item>
          <!-- 底部 -->
          <el-form-item>
            <el-button v-if="!isEdit" type="primary" @click="onSubmit"
              >立即添加</el-button
            >
            <el-button v-else type="primary" @click="onSubmit"
              >立即修改</el-button
            >
            <el-button @click="showAdd(false)">取消</el-button>
          </el-form-item>
        </el-form>
      </div>
    </el-dialog>
  </div>
</template>

<script>
import _ from "lodash";
import { mapActions, mapState, mapMutations } from "vuex";
import {
  addPromoteGameRecord,
  delPromoteGameRecord,
  updatePromoteGameRecord
} from "@/api/analyst";

export default {
  name: "exploits",
  data() {
    return {
      // 编辑弹框
      pageDialogVisible: false,
      isEdit: false,

      exploitsVisible: true,
      pageNum: 1,
      pageSize: 8,
      multipleSelection: [],
      form: {
        analystId: 0,
        gameDateTime: "",
        leagueName: "",
        teamOne: "",
        teamTwo: "",
        winnerTeam: "",
        score: "",
        result: ""
      }
    };
  },
  props: {
    analystId: {
      default: -1,
      type: Number
    }
  },
  computed: {
    ...mapState({
      // 分页信息
      exploitsListInfo: state => {
        const {
          exploitsListInfo = {
            current: this.pageNum,
            size: this.pageSize,
            total: 0
          }
        } = state.analyst;
        return exploitsListInfo;
      },
      // 分析师对应战绩
      exploitsList: state => {
        const { records = [] } = state.analyst.exploitsListInfo;
        return records;
      }
    })
  },
  methods: {
    ...mapActions({
      getPromoteGameRecord: "analyst/getPromoteGameRecord"
    }),
    ...mapMutations({
      EXPLOITS_LIST: "analyst/EXPLOITS_LIST"
    }),
    resetAllStatus() {
      this.pageDialogVisible = false;
      this.isEdit = false;
      this.form = {
        analystId: this.analystId,
        gameDateTime: "",
        leagueName: "",
        teamOne: "",
        teamTwo: "",
        winnerTeam: "",
        score: "",
        result: ""
      };
    },
    getPromoteGameRecordDetail() {
      const { pageNum, pageSize } = this;
      const param = {
        pageNum,
        pageSize,
        analystId: this.analystId
      };
      this.getPromoteGameRecord(param);
    },
    closeDialog() {
      this.$emit("closeDialog");
    },
    // 显示编辑框
    showAdd(bool) {
      this.pageDialogVisible = bool;
    },
    handleSelectionChange(val) {
      const arr = [];
      if (val && val.length) {
        val.map(item => {
          arr.push(item.id);
        });
      }
      this.multipleSelection = arr;
    },

    // 分页
    pagenatiOnchange(index) {
      this.pageNum = index;
      this.getPromoteGameRecordDetail();
    },

    handleEdit(item) {
      const data = _.cloneDeep(item);
      this.form = data;
      this.pageDialogVisible = true;
      this.isEdit = true;
    },

    // 批量删除
    delItems() {
      if (this.multipleSelection.length) {
        this.delItem(this.multipleSelection, true);
      }
    },

    delItem(idList, isMultiple = false) {
      if (idList && idList.length) {
        this.$confirm("确认删除？", {
          confirmButtonText: "确定",
          cancelButtonText: "取消"
        })
          .then(() => {
            delPromoteGameRecord(idList)
              .then(() => {
                this.getPromoteGameRecordDetail();

                // 重置状态
                if (isMultiple) {
                  this.multipleSelection = [];
                }
              })
              .catch(() => {});
          })
          .catch(() => {});
      }
    },
    // 删除
    handleDeleteSingle(item) {
      const arr = [item.id];
      this.delItem(arr);
    },

    onSubmit() {
      const { isEdit = false } = this;
      // 提交
      const {
        gameDateTime,
        leagueName,
        teamOne,
        teamTwo,
        winnerTeam,
        score,
        result
      } = this.form;
      this.form.analystId = this.analystId;

      if (!gameDateTime) {
        this.$message({
          message: "请选择比赛时间",
          type: "error"
        });
        return;
      }
      if (!leagueName) {
        this.$message({
          message: "请填写赛事名称",
          type: "error"
        });
        return;
      }
      if (!teamOne) {
        this.$message({
          message: "请填写主队名称",
          type: "error"
        });
        return;
      }
      if (!teamTwo) {
        this.$message({
          message: "请填写客队名称",
          type: "error"
        });
        return;
      }
      if (!winnerTeam) {
        this.$message({
          message: "请填写推荐队伍名称",
          type: "error"
        });
        return;
      }
      if (!score) {
        this.$message({
          message: "请填写比分",
          type: "error"
        });
        return;
      }
      if (!result) {
        this.$message({
          message: "请填写成绩",
          type: "error"
        });
        return;
      }
      if (this.analystId === -1) {
        this.$message({
          message: "请选择分析师",
          type: "error"
        });
        return;
      }

      if (isEdit) {
        updatePromoteGameRecord(this.form)
          .then(() => {
            this.$message({
              message: "修改成功",
              type: "success"
            });
            this.getPromoteGameRecordDetail();
            // 重置状态
            this.resetAllStatus();
          })
          .catch(error => {
            this.$message({
              message: error.msg,
              type: "error"
            });
          });
      } else {
        addPromoteGameRecord(this.form)
          .then(() => {
            this.$message({
              message: "添加成功",
              type: "success"
            });
            this.getPromoteGameRecordDetail();
            // 重置状态
            this.resetAllStatus();
          })
          .catch(error => {
            //
          });
      }
    }
  },
  mounted() {
    if (this.analystId !== -1) {
      // 初始化数据
      this.form.analystId = this.analystId;
      this.getPromoteGameRecord({
        analystId: this.analystId,
        pageNum: this.pageNum,
        pageSize: this.pageSize
      });
    }
  },
  destroyed() {
    this.EXPLOITS_LIST({});
  }
};
</script>

<style lang="scss" scoped>
.add_wrap {
  padding-bottom: 15px;
}
</style>
